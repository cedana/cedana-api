syntax = "proto3";

import "plugins/runc/runc.proto";
import "criu/criu.proto";
import "cedana/daemon/process.proto";
import "cedana/daemon/misc.proto";

package daemon;

service Daemon {
  // C/R
  rpc Dump(DumpReq) returns (DumpResp) {}
  rpc Restore(RestoreReq) returns (RestoreResp) {}

  // Job management
  rpc Run(RunReq) returns (RunResp) {}
  rpc Manage(ManageReq) returns (ManageResp) {}
  rpc List(ListReq) returns (ListResp) {}
  rpc Kill(KillReq) returns (KillResp) {}
  rpc Delete(DeleteReq) returns (DeleteResp) {}
  rpc Attach(stream AttachReq) returns (stream AttachResp) {}

  // Plugins
  rpc ReloadPlugins(Empty) returns (Empty) {}
}

////////////////////////
//////// DUMP //////////
////////////////////////

message DumpReq {
  string Dir = 1;
  bool Stream = 2;
  string Type = 3;
  criu.criu_opts Criu = 4;

  Details Details = 5;
}

message DumpResp {
  string Message = 1;
  string Path = 2;
  ProcessState State = 3;
}

////////////////////////
/////// RESTORE ////////
////////////////////////

message RestoreReq {
  string Path = 1;
  bool Stream = 2;
  string Type = 3;
  criu.criu_opts Criu = 4;
  string Log = 5;
  bool Attach = 6;

  Details Details = 7;
}

message RestoreResp {
  string Message = 1;
  uint32 PID = 2;
  ProcessState State = 3;
}

/////////////////
////// JOB //////
/////////////////

message RunReq {
  string JID = 1;
  bool GPUEnabled = 2;
  string Type = 3;
  string Log = 4;
  bool Attach = 5;
  Details Details = 6;
}

message RunResp {
  string Message = 1;
  uint32 PID = 2;
}

message ManageReq {
  string JID = 1;
  bool Attach = 2;
  Details Details = 3;
}

message ManageResp {
  string Message = 1;
  uint32 PID = 2;
}

message AttachReq {
  uint32 PID = 1;
  oneof Input {
    bytes Stdin = 2;
    int32 Signal = 3;
  }
}

message AttachResp {
  oneof Output {
    bytes Stdout = 1;
    bytes Stderr = 2;
    int32 ExitCode = 3;
  }
}

message ListReq {
  repeated string JIDs = 1;
}

message ListResp {
  repeated Job Jobs = 1;
}

message KillReq {
  repeated string JIDs = 1;
  int32 Signal = 2;
}

message KillResp {
  string Message = 1;
}

message DeleteReq {
  repeated string JIDs = 1;
}

message DeleteResp {
  string Message = 1;
}

message Job {
  string JID = 1;
  string Type = 2;
  ProcessState Process = 3;
  string CheckpointPath = 4;
  bool GPUEnabled = 5;
  string Log = 6;
  Details Details = 7;
}

message Details {
  optional string JID = 1;
  optional uint32 PID = 2;
  optional RunDetails ProcessRun = 3;

  // Plugin-specific job details:
  optional plugins.runc.Details Runc = 4;
  optional plugins.runc.RunDetails RuncRun = 5;
}

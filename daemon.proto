syntax = "proto3";

import "plugins/runc.proto";

package cedana.daemon;

service Daemon {
  rpc Dump(DumpReq) returns (DumpResp) {}
  rpc Restore(RestoreReq) returns (RestoreResp) {}
}

////////////////////////
//////// DUMP //////////
////////////////////////

message DumpReq {
  string Dir = 1;
  bool Stream = 2;
  DumpDetails Details = 3;
}

message DumpResp {
  string Dir = 1;
  string Message = 2;
}

message DumpDetails {
  string Type = 1;
  CriuOpts Criu = 2;
  oneof Opts {
    uint32 PID = 3;

    // Plugin-specific dump options:
    plugins.runc.DumpOpts Runc = 4;
  }
}

////////////////////////
/////// RESTORE ////////
////////////////////////

message RestoreReq {
  string Path = 1;
  bool Stream = 2;
  RestoreDetails Details = 3;
}

message RestoreResp {
  string Message = 1;
}

message RestoreDetails {
  string Type = 1;
  CriuOpts Criu = 2;
  oneof Opts {
    uint32 PID = 3;

    // Plugin-specific restore options:
    plugins.runc.RestoreOpts Runc = 4;
  }
}

////////////////////
/////// CRIU ///////
////////////////////

message CriuOpts {
  string ImagesDirectory = 1;
  string WorkDirectory = 2;
  string ParentImage = 3;
  bool LeaveRunning = 4;
  bool TcpEstablished = 5;
  bool ExternalUnixConnections = 6;
  bool ShellJob = 7;
  bool FileLocks = 8;
  bool PreDump = 9;
  bool Stream = 10;
  int32 EmptyNs = 11;
  bool AutoDedup = 12;
  bool LazyPages = 13;
  int32 StatusFd = 14;
  string LsmProfile = 15;
  string LsmMountContext = 16;
  repeated string External = 17;
}
